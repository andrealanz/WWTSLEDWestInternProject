---
title: "CSV Reader"
runtime: shiny
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(reticulate) #need to have Python and Conda installed (easiest way is by installing Anaconda, then adding it to your system path)
library(shiny)
library(readxl)
library(tools)
```

```{r include=FALSE}
source_python("csv_reader.py")
vendors <- read_excel("ActiveVendors.xls")
vendors <- sort(vendors$NAME)   #alphabetize vendors
#manufacturers <- read_excel("ActiveMFGs.xls")
#manufacturers <- sort(manufacturers$NAME)
```

```{r eruptions, echo=FALSE}
inputPanel(
  fileInput("file1", "Choose CSV File",
                multiple = FALSE,
                accept = c(".csv")),
  selectizeInput("vendorChoice", "Vendor", vendors, selected = NULL, multiple = FALSE, options = list(
          placeholder = 'Select a vendor',
          onInitialize = I('function() { this.setValue(""); }'))
  )
)

observe({
  if(!is.null(input$file1)){
    if(input$vendorChoice != "" 
       && file_ext((input$file1)$datapath) == "csv"){
      inFile <- input$file1
      error <<- try(
        csv_avt(inFile$name,inFile$datapath, input$vendorChoice)
      )
      mydata <<- read.csv(paste('wwt_',(input$file1)$name, sep = ""), check.names = FALSE)
      file.remove(paste('wwt_',(input$file1)$name, sep = ""))
    }
  }
})

renderText({
  if(!is.null(input$file1)){
    if(file_ext((input$file1)$datapath) != "csv"){
      "Error: Incorrect file extension"
    }
    else if(input$vendorChoice != ""){
        if(file_ext((input$file1)$datapath) == "csv"
       && is.null(error)){
          "Template Created"
        }
        else{
          "Invalid Data"
        }
    }
  }
})

output$download_button <- renderUI({
  if(!is.null(input$file1)) {
    if(input$vendorChoice != ""
       && file_ext((input$file1)$datapath) == "csv"){
      downloadButton("download", "Download")
    }
  }
})

output$viewCSV <- renderUI({
  if(!is.null(input$file1)){
    if(input$vendorChoice != ""
      && file_ext((input$file1)$datapath) == "csv"){
      actionButton("viewCSV", "View CSV")
    }
  }
})

output$download <- downloadHandler(
  filename = function() {
    if(!is.null(input$file1)){
      paste('wwt_', (input$file1)$name, sep = "")
    }
  },
  content = function(con) {
    if(!is.null(input$file1) 
       && input$vendorChoice != ""){
          write.csv(mydata, con, na = "", row.names = FALSE)
    }
  }
)

inputPanel(
  uiOutput("viewCSV"),
  uiOutput("download_button")
)

renderDataTable(
  if(!is.null(input$viewCSV)){
   if(input$viewCSV > 0 && input$vendorChoice != ""
      && file_ext((input$file1)$datapath) == "csv"){
      mydata
   }
  }
)

```
